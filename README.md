# Loyalty Service

В репозитории находится реализация микро-сервиса, который отвечает за работу 
системы лояльности и может использоваться в розничной торговле или сфере услуг,
везде, где за какую либо операцию (продажу) можно начислить определённое 
количество баллов лояльности, а потом потратить эти баллы на оплату товаров/услуг.

Доступные операции:
- Начисление баллов лояльности за операцию (loyaltyPoints/deposit).
- Отмена начисления баллов за операцию (loyaltyPoints/cancel).
- Оплата покупки баллами лояльности (loyaltyPoints/withdraw).
- Получение текущего баланса по карте лояльности (накопленное количество баллов лояльности) (account/balance).

При начислении баллов лояльности необходимо указать правило начисления.

Правило начисления может быть:
- Относительным — количество начисляемых баллов лояльности рассчитывается как процент от суммы операции.
- Абсолютным — в независимости от суммы операции начисляется фиксированное количество баллов лояльности.

Задача:
1. Архив репозитория распаковать и опубликовать в публичный GIT-репозиторий.
2. В отдельной ветке необходимо провести рефакторинг приложения в соответствии с Best Practices, Вашими предпочтениями и опытом.
3. Оформить Pull/Merge Request на ветку с исходным заданием и передать ссылку рекрутеру.

Рекомендации:
1. Предоставить краткое описание выбранных архитектурных решений.
2. Детализировать историю изменений вместо одного итогового коммита.
3. Соблюдать общепринятые правила оформления кода, документации и истории изменений.
4. Не углубляться в детали реализации непринципиальных моментов.
5. Не тратить на задание больше 1-2 дней.

1. При рефакторинге код переписывался на использование того функционала, что уже есть в арсенале Laravel.
Вместо работы с сырым $_POST берем Request, в котором данные уже отфильтрованы и мы можем не брать на себя задачу по экранированию и пр. Проверки входящих данных так-же отданы на Laravel'евский Validator.
Вместо static методов в модели, был создан репозиторий, который в целом можно и статически вызывать и фасад использовать, но я предпочитаю Service Container и не ленюсь прокидывать зависимости в аргументах методов.
Убраны вложенные if'ы - при меньшей вложенности проще читать. Убрано задание переменных внутри if'ов. Лично я это большим злом не считаю, но общепринято так не писать.
Дублирование кода убрано в отдельные методы. Добавлен макрос для response - error(). С одной стороны хорошо сокращает код, с другой стороны добавилась не совсем очевидная магия

## Installation

- Windows
```bash
cd test-task-loyalty-service; docker-compose up
docker run -it --user www -v ${pwd}:/var/www refactor-task-api /bin/sh -lc "composer install && cp .env.example .env && php artisan key:generate && php artisan migrate"
```

- Linux
```bash
docker-compose up
docker run -it -u "$(id -u):$(id -g)" -v $PWD:/var/www refactor-task-api /bin/sh -lc "composer install && cp .env.example .env && php artisan key:generate && php artisan migrate"
```
